version: '3'

tasks:
  run:
    desc: Run production docker setup
    cmds:
      - docker compose -f docker/docker-compose.yml up --build

  stop:
    desc: Stop and remove docker containers
    cmds:
      - docker compose -f docker/docker-compose.yml down

  localrun:
    desc: Run bot locally
    env:
      COMPOSE_BAKE: 1
    cmds:
      - docker compose -f docker/docker-compose-local.yml up --build

  lint:
    desc: Run linters (ruff + pyrefly)
    env:
      DJANGO_SETTINGS_MODULE: config.settings
    cmds:
      - uv run --no-sync ruff check --fix --config=pyproject.toml
      - uv run --no-sync pyrefly check

  format:
    desc: Format with Ruff
    cmds:
      - uv run --no-sync ruff format --config=pyproject.toml

  test:
    desc: Run tests
    env:
      DJANGO_SETTINGS_MODULE: config.test_settings
    cmds:
      - uv run --with pytest-asyncio pytest -q

  update:
    desc: Update dependencies (main + dev)
    cmds:
      - uv lock --upgrade
      - uv sync --all-extras
      - echo "✅ Dependencies updated"

  pre-commit:
    desc: Run pre-commit hooks
    cmds:
      - uv run pre-commit run --all-files

  migrate:
    desc: Make and apply Django migrations
    cmds:
      - docker compose exec api python apps/manage.py makemigrations
      - docker compose exec api python apps/manage.py migrate
      - echo "✅ Migrations applied"

  clean:
    desc: "Clean Redis and PostgreSQL. DO NOT USE IN PRODUCTION!"
    dotenv: ['.env']
    cmds:
      - |
        set -euo pipefail
        echo "Flushing Redis..."
        for i in $(seq 0 15); do
          docker compose exec -T redis redis-cli -n "$i" FLUSHDB >/dev/null
        done
        echo "Redis ✅"
      - |
        set -euo pipefail
        echo "Truncating PostgreSQL tables..."
        DB_USER_RESOLVED="${DB_USER:-${POSTGRES_USER:-postgres}}"
        DB_NAME_RESOLVED="${DB_NAME:-${POSTGRES_DB:-$DB_USER_RESOLVED}}"
        docker compose exec -T db psql -U "$DB_USER_RESOLVED" -d "$DB_NAME_RESOLVED" -t -q -v ON_ERROR_STOP=1 \
          -c "DO $$ DECLARE r RECORD; BEGIN FOR r IN (SELECT tablename FROM pg_tables WHERE schemaname = 'public' AND tablename NOT ILIKE 'django_%' AND tablename NOT ILIKE 'auth_%' AND tablename NOT ILIKE 'rest_framework_api_key_%') LOOP EXECUTE 'TRUNCATE TABLE ' || quote_ident(r.tablename) || ' CASCADE'; END LOOP; END $$;" >/dev/null
        echo "PostgreSQL ✅"
