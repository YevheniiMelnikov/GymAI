version: '3'

tasks:
  run:
    desc: Run production docker setup
    cmds:
      - docker compose -f docker-compose.yml up --build

  localrun:
    desc: Run bot locally
    env:
      COMPOSE_BAKE: 1
    cmds:
      - docker compose -f docker-compose-local.yml up --build

  lint:
    desc: Run linters (ruff + pyrefly)
    env:
      DJANGO_SETTINGS_MODULE: config.settings
    cmds:
      - uv run ruff check --fix --config=pyproject.toml
      - uv run pyrefly check .

  format:
    desc: Format with Ruff
    cmds:
      - uv run ruff format --config=pyproject.toml

  test:
    desc: Run tests
    env:
      DJANGO_SETTINGS_MODULE: config.test_settings
    cmds:
      - uv run --env-file .env pytest -q

  update:
    desc: Update dependencies (main + dev)
    cmds:
      - uv lock --upgrade
      - uv sync --extra dev

  update-win:
    desc: Sync deps in Windows venv (main + dev)
    cmds:
      - uv sync --extra dev --active

  pre-commit:
    desc: Run pre-commit hooks
    cmds:
      - uv run pre-commit run --all-files

  migrate:
    desc: Make and apply Django migrations
    cmds:
      - uv run --env-file .env python manage.py makemigrations
      - uv run --env-file .env python manage.py migrate
