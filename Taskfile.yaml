version: '3'

tasks:
  run:
    desc: Build and run containers (DEV mode)
    cmds:
      - docker compose -f docker/docker-compose-local.yml up -d --build

  runapi:
    desc: Rebuild and run API container (DEV mode)
    cmds:
      - docker compose -f docker/docker-compose-local.yml up -d --build api --no-deps

  lint:
    desc: Run linters (ruff + pyrefly)
    env:
      DJANGO_SETTINGS_MODULE: config.settings
    cmds:
      - uv run --no-sync ruff check --fix --config=pyproject.toml
      - uv run --no-sync pyrefly check

  format:
    desc: Format with Ruff
    cmds:
      - uv run --no-sync ruff format --config=pyproject.toml

  test:
    desc: Run tests
    env:
      DJANGO_SETTINGS_MODULE: config.test_settings
      XDG_CACHE_HOME: .uv-cache
    cmds:
      - uv run --with pytest-asyncio pytest -q {{.CLI_ARGS}}

  update:
    desc: Update dependencies (main + dev)
    cmds:
      - uv lock --upgrade
      - uv sync --all-extras
      - echo "âœ… Dependencies updated"

  pre-commit:
    desc: Run pre-commit hooks
    cmds:
      - uv run pre-commit run --all-files

  weekly-survey:
    desc: Trigger weekly survey flow (DEV only)
    cmds:
      - docker compose -f docker/docker-compose-local.yml exec -T api celery -A config.celery:celery_app call core.tasks.bot_calls.send_weekly_survey
