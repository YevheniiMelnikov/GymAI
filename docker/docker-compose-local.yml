x-app-image: &app_image gymbot-app:local
x-coach-image: &coach_image gymbot-coach:local

x-common-env: &common_env
#  userns_mode: "host"
  environment:
    PYTHONPATH: /app
    DJANGO_SETTINGS_MODULE: config.settings
    DEBUG_STATUS: "true"
    PYTHONUNBUFFERED: 1
    PYTHONDONTWRITEBYTECODE: 1
    REDIS_HOST: ${REDIS_HOST:-redis}
    REDIS_PORT: ${REDIS_PORT:-6379}
    RABBITMQ_HOST: ${RABBITMQ_HOST:-rabbitmq}
    RABBITMQ_PORT: ${RABBITMQ_PORT:-5672}
    POSTGRES_DB: ${DB_NAME}
    POSTGRES_USER: ${DB_USER}
    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
    POSTGRES_HOST: ${DB_HOST}
    POSTGRES_PORT: ${DB_PORT}
    AI_COACH_HOST: ${AI_COACH_HOST:-ai_coach}
    AI_COACH_PORT: ${COACH_PORT:-9000}
    VECTOR_DB_PROVIDER: ${VECTOR_DB_PROVIDER:-pgvector}
    PGVECTOR_HOST: ${PGVECTOR_HOST:-pgvector}
    PGVECTOR_PORT: ${PGVECTOR_PORT:-5432}
    PGVECTOR_DB: ${PGVECTOR_DB:-pgvector}
    PGVECTOR_USER: ${PGVECTOR_USER:-pgvector}
    PGVECTOR_PASSWORD: ${PGVECTOR_PASSWORD:-pgvector}
    VECTOR_DB_URL: ${VECTOR_DB_URL:-postgresql+asyncpg://${PGVECTOR_USER:-pgvector}:${PGVECTOR_PASSWORD:-pgvector}@${PGVECTOR_HOST:-pgvector}:${PGVECTOR_PORT:-5432}/${PGVECTOR_DB:-pgvector}}
    BOT_INTERNAL_HOST: ${BOT_UPSTREAM_HOST:-host.docker.internal}
    BOT_INTERNAL_PORT: ${BOT_UPSTREAM_PORT:-8088}
  env_file:
    - .env
  volumes:
    - ../:/app
    - ../apps/webapp/static:/app/staticfiles
    - cognee_storage:/app/cognee_storage
  depends_on:
    redis:
      condition: service_healthy
    rabbitmq:
      condition: service_healthy
    db:
      condition: service_healthy

services:
  bot:
    image: *app_image
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: py-runtime
      args:
        INSTALL_DEV: "true"
        EXTRAS: ""
    container_name: bot
    environment:
      GOOGLE_APPLICATION_CREDENTIALS: "/app/google_creds.json"
      DOCKER_BOT_START: ${DOCKER_BOT_START:-false}
      COGNEE_STORAGE_PATH: /app/cognee_storage
    <<: *common_env
    entrypoint: /bin/sh
    command: -lc 'if [ "${DOCKER_BOT_START}" = "true" ]; then exec /app/docker/entrypoint.sh python -m bot.main; else echo "bot disabled (DOCKER_BOT_START!=true)"; exec sleep infinity; fi'
    restart: unless-stopped
    networks: [internal]

  db:
    image: postgres:18
    container_name: db
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_HOST: ${DB_HOST}
      POSTGRES_PORT: ${DB_PORT}
    volumes:
      - pgdata:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    ports:
      - ${HOST_PG_PORT:-5432}:5432
    networks: [internal]

  pgvector:
    image: pgvector/pgvector:pg17-trixie
    environment:
      POSTGRES_DB: ${PGVECTOR_DB:-pgvector}
      POSTGRES_USER: ${PGVECTOR_USER:-pgvector}
      POSTGRES_PASSWORD: ${PGVECTOR_PASSWORD:-pgvector}
    volumes:
      - pgvector_data:/var/lib/postgresql/data
      - ./pgvector-init.sql:/docker-entrypoint-initdb.d/pgvector-init.sql:ro
    ports:
      - ${HOST_PGVECTOR_PORT:-15433}:5432
    networks: [internal]

#  qdrant:
#    image: qdrant/qdrant:v1.16
#    container_name: qdrant
#    restart: unless-stopped
#    environment:
#      QDRANT__SERVICE__HTTP_PORT: ${QDRANT_HTTP_PORT:-6333}
#      QDRANT__SERVICE__GRPC_PORT: ${QDRANT_GRPC_PORT:-6334}
#    ports:
#      - ${HOST_QDRANT_HTTP_PORT:-6333}:6333
#      - ${HOST_QDRANT_GRPC_PORT:-6334}:6334
#    volumes:
#      - qdrant_data:/qdrant/storage
#    networks: [ internal ]

  redis:
    image: redis:7-alpine
    container_name: redis
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    ports:
      - ${HOST_REDIS_PORT:-6379}:6379
    networks: [internal]

  rabbitmq:
    image: rabbitmq:4.1.4-management
    container_name: rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-rabbitmq}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-rabbitmq}
      RABBITMQ_DEFAULT_VHOST: ${RABBITMQ_VHOST:-/}
    entrypoint: /usr/local/bin/rabbitmq-entrypoint.sh
    volumes:
      - rabbitmqdata:/var/lib/rabbitmq
      - ./rabbitmq-entrypoint.sh:/usr/local/bin/rabbitmq-entrypoint.sh:ro
      - ./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
    ports:
      - "${HOST_RABBITMQ_PORT:-5672}:5672"
      - "${HOST_RABBITMQ_MANAGEMENT_PORT:-15672}:15672"
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks: [internal]

  api:
    image: *app_image
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: api-runtime
      args:
        INSTALL_DEV: true
        EXTRAS: ""
    container_name: api
    <<: *common_env
    environment:
      GOOGLE_APPLICATION_CREDENTIALS: /app/google_creds.json
      RUN_MIGRATIONS: true
      WEBAPP_AUTO_BUILD: "true"
      API_PORT: ${API_PORT:-8000}
      COGNEE_STORAGE_PATH: /app/cognee_storage
    entrypoint: /app/docker/entrypoint.sh
    command: >
      gunicorn config.asgi:application
      --worker-class uvicorn.workers.UvicornWorker
      --bind 0.0.0.0:${API_PORT:-8000}
      --workers 2
      --timeout 60
      --access-logfile -
      --error-logfile -
    depends_on:
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      db:
        condition: service_healthy
      ai_coach:
        condition: service_started
      pgvector:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:${API_PORT:-8000}/health/"]
      interval: 60s
      timeout: 5s
      retries: 5
      start_period: 5m
    volumes:
      - ../:/app
      - ../apps/webapp/static:/app/staticfiles
      - ../google_creds.json:/app/google_creds.json:ro
    ports:
      - ${HOST_API_PORT:-8000}:${API_PORT:-8000}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks: [internal]

  celery_worker:
    image: *app_image
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: py-runtime
      args:
        INSTALL_DEV: true
        EXTRAS: ""
    container_name: celery_worker
    <<: *common_env
    environment:
      SERVICE_ROLE: celery
      COGNEE_STORAGE_PATH: /app/cognee_storage
    entrypoint: /app/docker/entrypoint.sh
    command: >
      celery -A config.celery:celery_app worker
      -l info
      -Q default,critical,maintenance
      -P threads
    depends_on:
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      db:
        condition: service_healthy
      ai_coach:
        condition: service_started
      pgvector:
        condition: service_started
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks: [internal]

  ai_coach_worker:
    image: *app_image
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: py-runtime
      args:
        INSTALL_DEV: true
        EXTRAS: ""
    container_name: ai_coach_worker
    <<: *common_env
    environment:
      SERVICE_ROLE: ai_coach_worker
      COGNEE_STORAGE_PATH: /app/cognee_storage
    entrypoint: /app/docker/entrypoint.sh
    command: >
      celery -A config.celery:celery_app worker
      -l info
      -Q ai_coach
      -P threads
      --concurrency ${AI_COACH_WORKER_CONCURRENCY:-2}
    depends_on:
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      db:
        condition: service_healthy
      ai_coach:
        condition: service_started
      neo4j:
        condition: service_started
      pgvector:
        condition: service_started
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks: [internal]

  ai_coach:
    image: *coach_image
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: coach-runtime
      args:
        INSTALL_DEV: true
        EXTRAS: coach
    container_name: ai_coach
    <<: *common_env
    environment:
      SERVICE_ROLE: ai_coach
      SKIP_COLLECTSTATIC: "true"
      COGNEE_DEBUG: 1
      LOGURU_LEVEL: DEBUG
      COGNEE_STORAGE_PATH: /app/cognee_storage
      COGNEE_DATA_ROOT: /app/cognee_storage
      GRAPH_DATABASE_PROVIDER: ${GRAPH_DATABASE_PROVIDER}
      LLM_API_KEY: ${LLM_API_KEY}
      LLM_API_URL: https://openrouter.ai/api/v1
      OPENAI_API_KEY: ${LLM_API_KEY}
      OPENAI_BASE_URL: https://openrouter.ai/api/v1
      COACH_PORT: ${COACH_PORT:-9000}
    env_file:
      - .env
    volumes:
      - ../:/app
      - cognee_storage:/app/cognee_storage
    depends_on:
      redis:
        condition: service_healthy
      db:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      pgvector:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:${COACH_PORT:-9000}/health/"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 20s
    entrypoint: /app/docker/entrypoint.sh
    command: >
      bash -lc "uvicorn ai_coach.api:app --host 0.0.0.0 --port ${COACH_PORT:-9000}"
    ports:
      - ${HOST_COACH_PORT:-9000}:${COACH_PORT:-9000}
    networks: [internal]

  webapp_watch:
    image: node:20-alpine
    container_name: webapp_watch
    working_dir: /app/apps/webapp
    command: >
      sh -c "npm ci && VITE_OUT_DIR=/app/staticfiles/js-build npm run build:watch"
    environment:
      CHOKIDAR_USEPOLLING: "true"
      CHOKIDAR_INTERVAL: "800"
    volumes:
      - ../:/app
      - ../apps/webapp/static:/app/staticfiles
    networks: [internal]

  nginx:
    image: nginx:alpine
    container_name: nginx
    restart: unless-stopped
    volumes:
      - ./nginx.local.conf:/etc/nginx/conf.d/default.conf:ro
      - ../apps/webapp/static:/app/staticfiles:ro
    ports:
      - ${HOST_NGINX_PORT:-80}:80
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      api:
        condition: service_healthy
    networks: [internal]

  neo4j:
    image: neo4j:5.26
    container_name: neo4j
    volumes:
      - neo4j_logs:/logs
      - neo4j_config:/config
      - neo4j_data:/data
      - neo4j_plugins:/plugins
    environment:
      - NEO4J_AUTH=${GRAPH_DATABASE_USERNAME:-neo4j}/${GRAPH_DATABASE_PASSWORD:-pleaseletmein}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
    ports:
      - "${HOST_NEO4J_HTTP:-7474}:${NEO4J_HTTP_CONTAINER:-7474}"
      - "${HOST_NEO4J_BOLT:-7687}:${NEO4J_BOLT_CONTAINER:-7687}"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "cypher-shell -a bolt://localhost:${NEO4J_BOLT_CONTAINER:-7687} -u ${GRAPH_DATABASE_USERNAME:-neo4j} -p ${GRAPH_DATABASE_PASSWORD:-pleaseletmein} \"RETURN 1\" >/dev/null 2>&1",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    restart: unless-stopped
    networks: [internal]

  cloudflare:
    image: cloudflare/cloudflared:latest
    container_name: cloudflare
    restart: unless-stopped
    command: tunnel --no-autoupdate --config /etc/cloudflare/config.yml run
    environment:
      - TUNNEL_TOKEN=${CF_TUNNEL_TOKEN}
    volumes:
      - ./cloudflare-config.yml:/etc/cloudflare/config.yml:ro
    depends_on:
      - nginx
    networks: [internal]

networks:
  internal:
    name: gymbot_internal_local
    driver: bridge

volumes:
  cognee_storage:
  pgdata:
  pgvector_data:
  data_storage:
  rabbitmqdata:

  neo4j_logs:
  neo4j_config:
  neo4j_data:
  neo4j_plugins:
